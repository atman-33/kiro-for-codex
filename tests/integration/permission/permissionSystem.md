# 权限系统集成测试用例

## 测试文件

`permissionSystem.test.ts`

## 测试目的

验证权限系统中多个组件（ConfigReader、PermissionCache、PermissionManager）协同工作的正确性。集成测试减少 Mock 使用，测试真实的组件交互和数据流。

## 测试用例概览

| 用例 ID | 功能描述                     | 测试类型 |
| ------- | ---------------------------- | -------- |
| IS-01   | 权限授予完整流程             | 正向测试 |
| IS-02   | 文件变化触发缓存更新和事件   | 正向测试 |
| IS-03   | 权限撤销触发 UI 显示         | 正向测试 |
| IS-04   | 配置文件损坏时的恢复机制     | 异常测试 |
| IS-05   | 多个监听器协同响应权限变化   | 正向测试 |
| IS-06   | 初始化时文件不存在的完整流程 | 正向测试 |
| IS-07   | 并发操作的数据一致性         | 性能测试 |
| IS-08   | 组件生命周期管理             | 正向测试 |

## 详细测试步骤

### IS-01: 权限授予完整流程

**测试目的**: 验证从 UI 接受到文件写入的完整权限授予流程

**准备数据**:

- 使用临时目录模拟用户主目录
- 初始状态无权限

**测试步骤**:

1. 创建真实的 ConfigReader、PermissionCache 和 PermissionManager
2. 调用 PermissionManager.grantPermission()
3. 验证文件被写入
4. 验证缓存更新
5. 验证事件触发

**预期结果**:

- 配置文件被创建，内容正确
- 缓存返回 true
- 权限变化事件被触发
- 各组件日志输出正确

### IS-02: 文件变化触发缓存更新和事件

**测试目的**: 验证文件监控机制的完整工作流程

**准备数据**:

- 创建初始配置文件（权限为 false）
- 设置文件监控

**测试步骤**:

1. 创建组件并启动监控
2. 注册事件监听器
3. 外部修改配置文件（权限改为 true）
4. 等待文件监控触发
5. 验证事件链

**预期结果**:

- ConfigReader 检测到文件变化
- PermissionCache 自动刷新
- PermissionManager 接收到事件
- UI 相关方法被调用

### IS-03: 权限撤销触发 UI 显示

**测试目的**: 验证权限被撤销时的完整响应流程

**准备数据**:

- 初始权限为 true
- Mock UI 组件（WebView 和 Terminal）

**测试步骤**:

1. 创建组件并设置初始权限
2. 调用 resetPermission()
3. 验证文件更新
4. 验证事件触发
5. 验证 UI 调用

**预期结果**:

- 配置文件权限字段变为 false
- 触发权限撤销事件
- 显示警告消息
- 创建权限设置 UI

### IS-04: 配置文件损坏时的恢复机制

**测试目的**: 验证系统对损坏配置文件的处理能力

**准备数据**:

- 创建包含无效 JSON 的配置文件
- 设置各种损坏场景

**测试步骤**:

1. 创建损坏的配置文件
2. 初始化权限系统
3. 尝试授予权限
4. 验证文件被修复
5. 验证系统正常工作

**预期结果**:

- 读取时返回 false（安全默认值）
- 写入时保留有效字段
- 无效内容被忽略
- 系统继续正常运行

### IS-05: 多个监听器协同响应权限变化

**测试目的**: 验证多个组件监听同一事件源的协同工作

**准备数据**:

- 创建多个事件监听器
- 模拟不同的响应动作

**测试步骤**:

1. 创建权限系统
2. 注册多个监听器（模拟不同组件）
3. 触发权限变化
4. 验证所有监听器响应
5. 验证执行顺序

**预期结果**:

- 所有监听器接收到事件
- 执行顺序符合预期
- 没有竞态条件
- 日志记录完整

### IS-06: 初始化时文件不存在的完整流程

**测试目的**: 验证首次使用时的完整初始化流程

**准备数据**:

- 确保配置文件不存在
- Mock UI 交互

**测试步骤**:

1. 删除配置文件（如果存在）
2. 创建权限系统
3. 调用 initializePermissions()
4. 模拟用户接受权限
5. 验证文件创建

**预期结果**:

- 显示权限设置 UI
- 用户接受后创建配置文件
- 目录自动创建
- 权限状态正确保存

### IS-07: 并发操作的数据一致性

**测试目的**: 验证并发读写时的数据一致性

**准备数据**:

- 准备并发操作场景
- 设置多个操作源

**测试步骤**:

1. 创建权限系统
2. 同时触发多个操作：
   - 读取权限状态
   - 写入权限状态
   - 刷新缓存
3. 等待所有操作完成
4. 验证最终状态

**预期结果**:

- 所有操作成功完成
- 最终状态一致
- 没有数据竞态
- 缓存与文件同步

### IS-08: 组件生命周期管理

**测试目的**: 验证组件创建、使用和销毁的完整生命周期

**准备数据**:

- 创建完整的权限系统
- 设置各种资源（监听器、文件监控等）

**测试步骤**:

1. 创建所有组件
2. 执行各种操作
3. 调用 dispose() 方法
4. 验证资源清理
5. 尝试使用已销毁的组件

**预期结果**:

- 所有资源被正确清理
- 文件监控停止
- 事件监听器移除
- 后续调用不会导致错误

## 测试注意事项

### Mock 策略

- 仅 Mock 必要的外部依赖（如 vscode UI 组件）
- 使用真实的文件系统（临时目录）
- 使用真实的组件实例
- 保留组件间的真实交互

### 文件系统

- 使用临时目录避免污染真实环境
- 每个测试后清理临时文件
- 模拟真实的文件路径结构
- 测试文件权限问题

### 异步处理

- 文件监控需要等待
- 使用适当的延迟等待文件系统事件
- 避免使用固定延迟，使用事件驱动
- 正确处理 Promise 链

### 事件同步

- 确保事件按预期顺序触发
- 避免事件丢失
- 处理异步事件的时序问题
- 验证事件参数正确

### 错误边界

- 测试各种错误场景
- 验证错误不会破坏系统状态
- 确保错误被正确记录
- 验证错误恢复机制
